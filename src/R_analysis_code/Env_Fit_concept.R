# Assume one locus "m2" affects fitness
# The relationships between that locus and fitness
# in different environments is given by this function:
require(ggplot2)
colfunc<-colorRampPalette(c("orange","cyan"))
# for now don't worry about the math, 
# just look at the plot after the function
get_fitness_from_env_m2 <- function(env, s){
  fitness <- c()
  fitness[env<5] <-  1 + s*env[env<5]
  fitness[env>=5] <- 1 + s*4 + -3*s*(env[env>=5]-5)
  return(fitness)
}

get_fitness_from_env_m2_b <- function(env, s){
  fitness <- c()
  fitness[env<1] <-  1 + s*env[env<1]
  fitness[env>=1] <- 1 +s + -3*s*(env[env>=1]-1)
  return(fitness)
}


get_fitness_from_env_m2_2 <- function(env, s){
  fitness <- c()
  fitness <-  1 - s*env
  return(fitness)
}

#Alt
# get_fitness_from_env_m2 <- function(env, s){
#   fitness <- c()
#   fitness <-  1 + s*env
#   return(fitness)
# }

# In this case I am considering a type of thermal performance curve
# approximated with two linear functions
env <- -4.5:8.5
get_fitness_from_env_m2(env, 0.1)
plot(env, get_fitness_from_env_m2(env, 0.1),xlim=c(-4.5,8.5), ylim=c(0,2), 
     type="l", col=colfunc(10), lwd=2,
     xlab="Environment", ylab="Fitness conferred by mutation")
#lines(env,get_fitness_from_env_m2_2(env,0.8), col="red")
abline(h=1)


env_b <- seq(-1,2,0.2)
get_fitness_from_env_m2_b(env_b, 0.45)
plot(env, get_fitness_from_env_m2_b(env_b, 0.45),xlim=c(-1,2.5), ylim=c(0,2), 
     type="l", col=colfunc(10), lwd=2,
     xlab="Environment", ylab="Fitness conferred by mutation")
#lines(env,get_fitness_from_env_m2_2(env,0.8), col="red")
abline(h=1)

env_fit<-data.frame(env, get_fitness_from_env_m2(env, 0.8))
env_fit$Col <- c(2:10,20,20,20,20,20)
env_fit$Col <- c(1,2,3,4)

ggplot(data=env_fit,aes(x = env_fit$env, y = env_fit$get_fitness_from_env_m2.env..0.1., colour=env_fit$Col)) +
  geom_line(size = 2)  +
  scale_colour_gradient2(low="orange", mid="cyan",high="red",midpoint =10,guide=F)+
  theme(legend.position="none")+
  xlab("Environment")+
  scale_x_discrete(limits=c(seq(-4.5,8,2)))+
  ylab("Relative Fitness conferred by mutation")+
  #coord_cartesian(xlim=c(-4,8),ylim=c(0.4,1.5),expand = T)+
  #ylim(0.2,1.6)+
  scale_y_continuous(breaks = c(.4,.6,.8,1,1.2,1.4), limits=c(0.3,1.5))+
  theme_bw(base_size = 16)+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),)+
  theme(axis.title.y = element_text(size=14))+
  geom_hline(yintercept = 1)

# Next we want to model environment change
# for each location `x` from 0 to 9
# this will depend on the generation and the rate
# of climate change
# Again, check out the figures first and then look at the math
get_env_from_x <- function(x, gen, rate){
  if (gen < 2000){ # burnin
    env <- x-4.5
  }
  if (gen > 2000){ # climate change
    env <- x-4.5 + rate*(gen-2000)
  }
  return(env)
}

x<- 0:9
env_1000 <- get_env_from_x(0:9, 1000, 0.01)
par(mar=c(4,4,1,1))
plot(x, env_1000, ylim=c(-5, 10), type="l",
     ylab="Environment",
     xlab="location")
abline(h=0)
# I model the environment with an average of 0 at the 
# central x location before climate change
mean(env_1000)

env_2100 <- get_env_from_x(0:9, 2100, 0.01)
points(x, env_2100, col="blue", type="l")

env_3000 <- get_env_from_x(0:9, 3000, 0.01)
points(x, env_3000, col="red", type="l")
# note that this climate change
# would be "off the chart"
# for the "get_fitness_from_env_m2" function
# these are just conceptual examples
# we need to think about parameterization carefully

# Now, we can combine these functions to get the 
# FITNESS OF THE M2 mutation as a function of x-location that we 
# should model through time
# We should be careful to always distinguish this from the 
# INDIVIDUAL FITNESS
# which depends on their genotype and environment
# and the 
# POPULATION MEAN FITNESS
# that evolves through time before and after climate change

get_m2_fitness_from_x <- function(x, gen, rate, s){
  env <- get_env_from_x(x, gen, rate)
  fitness <- get_fitness_from_env_m2(env, s)
  return(fitness)
}

x <- 0:9
plot(x, get_m2_fitness_from_x(x, 1000, 0.01, 0.1),
     ylab= "fitness", type="l", ylim=c(0,1.5))
# this is the modeled fitness of m2

points(x, get_m2_fitness_from_x(x, 2100, 0.01, 0.1),
       ylab= "fitness", col="blue", type = "l")

points(x, get_m2_fitness_from_x(x, 2200, 0.01, 0.1),
       ylab= "fitness", col="red", type = "l")

points(x, get_m2_fitness_from_x(x, 2300, 0.01, 0.1),
       ylab= "fitness", col="orange", type = "l")

points(x, get_m2_fitness_from_x(x, 2500, 0.01, 0.1),
       ylab= "fitness", col="green", type = "l")

# because population size is indpendent of m2 fitness
# we need to be careful not to model 0 fitness
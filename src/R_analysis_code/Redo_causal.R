require(OutFLANK)
require(vcfR)
require(adegenet)
require(gdm)
require(gradientForest)
require(foreach)
require(doParallel)
require(pbapply)
require(gdata)
require(data.table)
require(PresenceAbsence)
require(ROCR)
require(modEvA)
require(dplyr)
require(grid)
require(gridExtra)
require(gtools)
require(stringr)
require(reshape2)
require(hierfstat)
require(clusterGeneration)


options(scipen = 999)

setwd("E:/Research_AJL/TTT_Offset_Vulnerability_GF_Sims/")

seed_table <- read.table("seeds_source_R.txt")

for(w in 1:nrow(seed_table)){
Tot_time_start  <- Sys.time()
  seed_table <- read.table("seeds_source_R.txt")
  
  seed=seed_table$V2[w]
  
load(paste("results/R_results/",seed,".RData",sep=""))

muts <- scan(paste("results/SLiM_output/",seed,"_casual_muts2.txt",sep=""))
if(any(duplicated(muts))){
  print("Duplicates in positions!")
  break
}

select_pos <- paste("M",muts,sep="")

alFreq_sel<-alFreq[colnames(alFreq)%in%select_pos]

start_time <- Sys.time()
gfMod_sel <- gradientForest2(data=data.frame(envTab[, vars], alFreq_sel),
                             predictor.vars=vars,
                             response.vars=colnames(alFreq_sel),
                             corr.threshold=0.5 ,
                             ntree=500,
                             trace=T)
end_time <- Sys.time()
writeLines("GF causal calculation:")
print(end_time - start_time)

GF_dist_caus <- NULL

for(i in 1:ncol(envTab)){
  tmp <- data.frame(envTab[,i])
  colnames(tmp) <- colnames(envTab)[i]
  
  writeLines(paste("Predicting ",colnames(envTab)[i]))
  gftmp <- predict(gfMod_sel, tmp)
  
  GF_dist_caus <- data.frame(c(GF_dist_caus,gftmp))
}

#Genome under selection
Gt1f_sel<-Gt1f[,colnames(Gt1f)%in%select_pos]
Pre_geno_sel<-data.frame(PopsALL,Gt1f_sel)
colnames(Pre_geno_sel)[1]<-"Locality"

Pre_geno_sel_Edge <- Pre_geno_sel[Pre_geno_sel$Locality%in%Edges,]

start_time <- Sys.time()
Pre_FST_sel_Edge<-pairwise.WCfst(Pre_geno_sel_Edge,diploid = T)
end_time <- Sys.time()
print(end_time - start_time)

mean(Pre_FST_sel_Edge, na.rm=T)

Cores <- c(34, 35, 36, 37, 44, 45, 46, 47, 54, 55, 56, 57, 64, 65, 66, 67)

Pre_geno_sel_Cores <- Pre_geno_sel[Pre_geno_sel$Locality%in%Cores,]

start_time <- Sys.time()
Pre_FST_sel_Cores<-pairwise.WCfst(Pre_geno_sel_Cores,diploid = T)
end_time <- Sys.time()
print(end_time - start_time)

mean(Pre_FST_sel_Cores, na.rm=T)

R2_sel<-data.frame(gfMod_sel$result) #Those allelese which had an R2 value > 0
colnames(R2_sel)<-"R2_adapt"

CI_sel<-NULL
for(i in 1:nrow(GF_dist_caus)){
  for(j in 1:nrow(GF_dist_caus)){
    CI_sel<-c(CI_sel,dist(rbind(GF_dist_caus[i,],GF_dist_caus[j,])))
    #CI<-c(CI,CI_bf[j]-CI_bf[i])
  }
}

cg_df$D_CI_caus_allEnv<-CI_sel

GFcaus_dist_caus<-GF_dist_caus[,c(1,2)]
CIcaus_causal<-NULL
for(i in 1:nrow(GFcaus_dist_caus)){
  for(j in 1:nrow(GFcaus_dist_caus)){
    CIcaus_causal<-c(CIcaus_causal,dist(rbind(GFcaus_dist_caus[i,],GFcaus_dist_caus[j,])))
    #CI<-c(CI,CI_bf[j]-CI_bf[i])
  }
}

cg_df$D_CI_caus_causEnv<-CIcaus_causal

options(scipen = 0)

dat_sum<-cor.test(x=cg_df$D_CI_allEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$D_CI_allEnv, y=cg_df$Fitness)
paste("rho = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$D_CI_causEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$D_CI_causEnv, y=cg_df$Fitness)
paste("rho = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$D_CI_caus_allEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$D_CI_caus_allEnv, y=cg_df$Fitness)
paste("rho = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$D_CI_caus_causEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$D_CI_caus_causEnv, y=cg_df$Fitness)
paste("rho = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$EdSelEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$EdSelEnv, y=cg_df$Fitness)
paste("r = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$MdSelEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$MdSelEnv, y=cg_df$Fitness)
paste("r = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$EdAllEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$EdAllEnv, y=cg_df$Fitness)
paste("r = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$MdAllEnv, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$MdAllEnv, y=cg_df$Fitness)
paste("r = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$EdSelEnvPlus2, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$MdAllEnv, y=cg_df$Fitness)
paste("r = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

dat_sum<-cor.test(x=cg_df$MdSelEnvPlus2, y=cg_df$Fitness, method = "spearman")
#plot(x=cg_df$MdSelEnvPlus2, y=cg_df$Fitness)
paste("r = ",round(dat_sum$estimate[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")

Pre_FST_Cores[is.na(Pre_FST_Cores)]<-0
Pre_FST_Edge[is.na(Pre_FST_Edge)]<-0
Pre_FST_sel_Cores[is.na(Pre_FST_sel_Cores)]<-0
Pre_FST_sel_Edge[is.na(Pre_FST_sel_Edge)]<-0

cg_df_Edges <- cg_df[as.numeric(substr(as.character(cg_df$Home),2,nchar(as.character(cg_df$Home))))%in%c(Edges,Cores),]
cg_df_Edges <- cg_df_Edges[as.numeric(substr(as.character(cg_df_Edges$Transplant),2,nchar(as.character(cg_df_Edges$Transplant))))%in%Edges,]

cg_df_Edges$Pre_FST <- as.vector(Pre_FST_Edge)
cg_df_Edges$Pre_FSt_sel <- as.vector(Pre_FST_sel_Edge)

cg_df_Cores <- cg_df[as.numeric(substr(as.character(cg_df$Home),2,nchar(as.character(cg_df$Home))))%in%c(Edges,Cores),]
cg_df_Cores <- cg_df_Cores[as.numeric(substr(as.character(cg_df_Cores$Transplant),2,nchar(as.character(cg_df_Cores$Transplant))))%in%Cores,]

cg_df_Cores$Pre_FST <- as.vector(Pre_FST_Cores)
cg_df_Cores$Pre_FSt_sel <- as.vector(Pre_FST_sel_Cores)

#compare edge pops
dat_sum<-cor.test(x=cg_df_Edges$D_CI_allEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
#summary(dat_sum)
GF_off_genome_allEnv_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$D_CI_causEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
GF_off_genome_causEnv_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$D_CI_caus_allEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
GF_off_causal_allEnv_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$D_CI_caus_causEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
GF_off_causal_causEnv_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$EdSelEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_ED_caus_env_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$MdSelEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_MD_caus_env_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$EdAllEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_ED_all_env_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$MdAllEnv, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_MD_all_env_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$EdSelEnvPlus2, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_ED_causP2_env_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$MdSelEnvPlus2, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_MD_causP2_env_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$Pre_FST, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
FST_genome_Edges <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Edges$Pre_FSt_sel, y=cg_df_Edges$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
FST_causal_Edges <- round(dat_sum$estimate[[1]],3)

#compare core pops
dat_sum<-cor.test(x=cg_df_Cores$D_CI_allEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
GF_off_genome_allEnv_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$D_CI_causEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
GF_off_genome_causEnv_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$D_CI_caus_allEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
GF_off_causal_allEnv_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$D_CI_caus_causEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
GF_off_causal_causEnv_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$EdSelEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_ED_caus_env_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$MdSelEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_MD_caus_env_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$EdAllEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_ED_all_env_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$MdAllEnv, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_MD_all_env_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$EdSelEnvPlus2, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_ED_causP2_env_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$MdSelEnvPlus2, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
Env_MD_causP2_env_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$Pre_FST, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
FST_genome_Cores <- round(dat_sum$estimate[[1]],3)

dat_sum<-cor.test(x=cg_df_Cores$Pre_FSt_sel, y=cg_df_Cores$Fitness, method = "spearman")
paste("r = ",round(dat_sum$estimate[[1]],3),"\nslope = ", round(dat_sum$statistic[[1]],3),"\np-value = ", signif(dat_sum$p.value,3),sep="")
FST_causal_Cores <- round(dat_sum$estimate[[1]],3)

case <- data.frame(GF_off_genome_allEnv_Edges, 
                   GF_off_genome_causEnv_Edges, 
                   GF_off_causal_allEnv_Edges, 
                   GF_off_causal_causEnv_Edges, 
                   Env_ED_caus_env_Edges,
                   Env_MD_caus_env_Edges,
                   Env_ED_all_env_Edges,
                   Env_MD_all_env_Edges,
                   Env_ED_causP2_env_Edges,
                   Env_MD_causP2_env_Edges, 
                   FST_genome_Edges, 
                   FST_causal_Edges,
                   GF_off_genome_allEnv_Cores, 
                   GF_off_genome_causEnv_Cores, 
                   GF_off_causal_allEnv_Cores, 
                   GF_off_causal_causEnv_Cores, 
                   Env_ED_caus_env_Cores,
                   Env_MD_caus_env_Cores,
                   Env_ED_all_env_Cores,
                   Env_MD_all_env_Cores,
                   Env_ED_causP2_env_Cores,
                   Env_MD_causP2_env_Cores, 
                   FST_genome_Cores, 
                   FST_causal_Cores)

write.csv(case, paste("results/R_results/Case",seed_table$V5[w],"_",seed,"_corr_allEnv.csv",sep=""),row.names = F)

save.image(paste("results/R_results/",seed,".RData",sep=""))

Tot_time_end <- Sys.time()
writeLines("Total time:")
print(Tot_time_end - Tot_time_start)

rm(list=ls())
gc()
}

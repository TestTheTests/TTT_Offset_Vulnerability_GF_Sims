#Processing of SLiM output from FullFathomFive_SP_100_###.slim codes from 
# output visualization to Gradient Forest analysis 

setwd("/Users/akijarl/Desktop/")

require(adegenet)
require(gdm)
require(gradientForest)
require(foreach)
require(doParallel)
require(OutFLANK)
require(pbapply)
require(gdata)
require(data.table)
require(PresenceAbsence)
require(ROCR)
require(modEvA)
require(ggplot2)
require(grid)
require(gridExtra)
require(gtools)
require(cowplot)

##############################################
#Read in the two SLiM simulation output files
##############################################

#Specify plot title to reflect specific of simulation to be visualized
plotTitle <- "FFF_output_SP_100_1772056440191\n Gen. 5000, recomb. 1e-8, mig. 0.05, sel. 0.1"

fit<-read.table("Fit_output_SP_100_1772056440191.txt") # 5000 gen sim. with 4500 gen burnin, assoc. neutral allele frequency 
freq<-read.table("Freq_output_SP_100_1772056440191.txt") # Neutral allele frequency of 1000 haphazardly sampled neutral mutations at gen. 5000 

fit_nam <- NULL
for(i in 1:100){
  fit_nam <- c(fit_nam,print(paste("P",i,"_fit",sep="")))
}

freq_nam <- NULL
for(i in 1:100){
  freq_nam <- c(freq_nam,print(paste("P",i,"_freq",sep="")))
}

gen_nam <- NULL
for(i in seq(10,5000,10)){
  gen_nam <- c(gen_nam,print(paste("Gen",i,sep="")))
}

colnames(fit) <- c("Gen",fit_nam,freq_nam)

plot(fit$Gen[450:500],fit$P19_fit[450:500],type="l",main=plotTitle ,xlab="Generations",ylab="Fitness",col="red",ylim=c(min(fit[,c(2:101)]),max(fit[,c(2:101)])))
for(i in 2:101){
  lines(fit$Gen[450:500],fit[450:500,i])
}
lines(fit$Gen[450:500],fit$P19_fit[450:500], col="red")

plot(fit$Gen[450:500],fit$P19_freq[450:500],type="l", main=plotTitle, xlab="Generations",ylab="M2 allele frequency",col="red",ylim=c(0,1))
for(i in 102:201){
  lines(fit$Gen[450:500],fit[450:500,i])
}
lines(fit$Gen[450:500],fit$P19_freq[450:500], col="red")

fit<-data.frame(t(fit))
fit<-fit[-1,]
colnames(fit)<-gen_nam

fit$Environment <- as.factor(rep(c(0.90,0.92,0.94,0.97,0.99,1.01,1.03,1.06,1.08,1.10),20)) 
fit$Type <- as.factor(c(rep("Fit",100),rep("Freq",100)))

Fit <- ggplot(aes(y=Gen5000, x=Environment), data = fit[fit$Type=="Fit",]) + 
  geom_boxplot() +
  ylab("Mean Pop. Fitness")+
  ggtitle("FFF_output_SP_100_1772056440191\n Gen. 5000, recomb. 1e-8, mig. 0.05, sel. 0.1")+
  theme_set(theme_gray())
Freq <- ggplot(aes(y=Gen5000, x=Environment), data = fit[fit$Type=="Freq",]) + 
  geom_boxplot() +
  ylab("Pop. M2 Allele Frequency")+
  ggtitle("FFF_output_SP_100_1772056440191\n Gen. 5000, recomb. 1e-8, mig. 0.05, sel. 0.1")+
  theme_set(theme_gray())

plot_grid(Fit, Freq, labels = NULL)

#######################################
#Prepare data for GF analysis
#######################################

M2 <- data.frame(fit[101:200,500:501])
colnames(M2)[1]<-"M2"

mut_nam <- NULL
for(i in 1:1000){
  mut_nam <- c(mut_nam,paste("M1",i,sep="_"))
}
colnames(freq)<-mut_nam

alFreq<-cbind(freq,M2)
alFreq<-alFreq[,-1002]

envPop<-data.frame(as.numeric(levels(M2$Environment))[M2$Environment])
names(envPop) <- "envSelect"

# number of cores to use for parallel processing
cores <- 2

#####
# build output GF data frames
gfR2tab <- function(gfMods.list, alFreqs){
  i=1
  while(is.null(gfMods.list[[i]])){i=i+1}
  tab <- do.call(rbind, gfMods.list)
  vrNm <- rep(row.names(tab)[1:nrow(gfMods.list[[i]])], 
              nrow(tab)/nrow(gfMods.list[[i]]))
  tab <- data.frame(variable=vrNm, tab)
  tab <- dcast(tab, SNPnames~variable, value.var="imps")
  envR2 <- rowSums(data.frame(tab[,-1]))
  R2Tab <- data.frame(tab, envR2=envR2)
  
  # get name of SNP if it has a positive R2
  posR2 <- unlist(lapply(gfMods.list, function(x){
    return(as.character(unique(x[,2])))}))
  
  # Find which loci have R2 < 0 (no GF model for those) & assign R2=0
  negR2 <- !(colnames(alFreqs) %in% posR2)
  negR2 <- colnames(alFreqs)[negR2] 
  
  noGF <- data.frame(matrix(0, nrow=length(negR2), ncol=ncol(R2Tab)))
  colnames(noGF) <- colnames(R2Tab)           
  noGF$SNPnames <- negR2
  
  R2Tab <- rbind(R2Tab, noGF)
  return(R2Tab[order(R2Tab$SNPnames),])}


########################
cl <- makeCluster(cores)
registerDoParallel(cl)

# use for each to run in parallel - each SNP modeled by GF on different
# processor
gfAllele.freq <- foreach(k=1:ncol(alFreq), .verbose=F, .packages=c("gradientForest", "data.table")) %dopar% {
  # get locus k & name with SNP ID
  locus <- data.frame(alFreq[,k])
  names(locus) <- colnames(alFreq)[k]
  
  # here's the GF modeling function
  gfLocus <- gradientForest(data=data.frame(envPop, locus),
                            predictor.vars=colnames(envPop), 
                            response.vars=colnames(alFreq)[k], 
                            corr.threshold=0.5, 
                            ntree=500, 
                            trace=F)
  
  # get result is the model is not = NULL (no fit)
  if(!is.null(gfLocus)){
    # cumulative importance values (to plot turnover functions)
    cImp <- cumimp(gfLocus, "envSelect", type="Species")
    cImp <- data.frame(rbindlist(cImp, idcol="allele"))
    # return data frame with allele ID, cumulative importance results,
    # and R2 value for GF model
    data.frame(cImp, r2=gfLocus$result)
  }
}
stopCluster(cl)

# Prep table of importance values for each SNP (rows) 
# and each var (columns)
gfAF <- lapply(gfAllele.freq, function(x){
  if(!is.null(x)){
    ttt <- x[1,c("r2", "allele")]
    return(data.frame(imps=ttt$r2, SNPnames=ttt$allele, row.names = "envSelect",
                      stringsAsFactors=F))}})

# run function to convert to table # then write to file
gfAllele.R2.af <- gfR2tab(gfAF, alFreq)
gfAllele.R2.af <- gfAllele.R2.af[match(mixedsort(gfAllele.R2.af$SNPnames), 
                                       gfAllele.R2.af$SNPnames),]
gfAllele.R2.af$SNPnames <- gsub("S", "", gfAllele.R2.af$SNPnames)

finalOut <- data.frame(SNPnames=gfAllele.R2.af$SNPnames, 
                       #cImp.envSelect.alleleFreq=gfAllele.R2.af$envSelect,
                       r_squared.alleleFreq=gfAllele.R2.af$envR2)

write.table(finalOut, "alFreq_1772056440191_gradientforests.Cpval", row.names=F)

save(gfAllele.freq, file="alFreq_1772056440191_gradientforests.Rdata")


impData <- gfAllele.freq

impDatList <- gfAllele.freq[unlist(lapply(gfAllele.freq, function(x){!is.null(x)}))]
impDat <- do.call(rbind, impDatList)

cImpMAF.sel<-impDat[which(impDat$allele=="M2"),]

p.imp <- ggplot() + geom_line(data=impDat, aes(x=x, y=y, group=allele),
                              colour=rgb(0,0,0,0.4), lwd=0.5) +
  #facet_grid(. ~ strSel) +
  labs(y="Cumulative Importance", x="Environment") +
  #geom_line(data=cImpMAF.neut, aes(x=x, y=y),
  #          colour=rgb(0,0,1, 0.75), lwd=1) +
  geom_line(data=cImpMAF.sel, aes(x=x, y=y),
            colour=rgb(1,0,0, 0.75), lwd=1) +
  #geom_line(data=cImpMAF, aes(x=x, y=y),
  #          colour=rgb(0,0,0, 0.75), lwd=1) +
  theme(plot.margin = unit(c(1.25,1.25,1.25,1.25), "in")) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 18, colour = "grey60"),
        axis.title.x = element_text(size=24)) +
  theme(axis.text.y = element_text(size = 16, colour = "grey60"),
        axis.title.y = element_text(size=24, vjust=1)) +
  theme(strip.text = element_text(size=16)) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(size=14, face="bold.italic"))

p.imp
